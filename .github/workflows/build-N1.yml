name: build-N1

on:
  workflow_dispatch:
    inputs:
      luci_version:
        description: "选择luci版本"
        required: false
        default: "24.10.4"
        type: choice
        options:
          - 24.10.0
          - 24.10.1
          - 24.10.2
          - 24.10.3
          - 24.10.4

      include_docker:
        description: "是否编译 Docker 插件"
        required: true
        default: 'no'
        type: choice
        options:
          - 'yes'
          - 'no'

      enable_store:
        description: "集成 store 商店"
        required: false
        type: boolean
        default: true

      skip_imagebuilder:
        description: "跳过 ImageBuilder，使用预构建 rootfs"
        required: false
        default: false
        type: boolean

      replace_banner:
        description: "替换为 ImmortalWrt banner"
        required: false
        default: false
        type: boolean

      rootfs_partsize:
        description: "rootfs 大小"
        required: true
        default: "1024"
        type: choice
        options:
          - '1024'

      builder_name:
        description: "打包作者名称"
        required: true
        default: 'wukongdaily'

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set executable permissions
        run: chmod +x "${{ github.workspace }}/n1/build.sh"

      - name: Debug workspace contents
        run: ls -R

      - name: Enable Store integration
        run: |
          if [ "${{ github.event.inputs.enable_store }}" == "true" ]; then
            echo 'CUSTOM_PACKAGES="$CUSTOM_PACKAGES luci-app-store"' >> shell/custom-packages.sh
          fi

      - name: Replace banner
        if: ${{ github.event.inputs.skip_imagebuilder == 'false' && github.event.inputs.replace_banner == 'true' }}
        run: |
          mkdir -p files/etc/uci-defaults
          cp n1/99-banner.sh files/etc/uci-defaults/

      - name: Clean extra-packages (keep only Passwall2 / MosDNS / TurboACC / Docker)
        run: |
          echo "清理 run 包，只保留旁路由需要的插件"
          mkdir -p extra-packages-clean
          if ls extra-packages/*.run >/dev/null 2>&1; then
