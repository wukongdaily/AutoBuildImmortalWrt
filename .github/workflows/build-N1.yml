name: build-N1-Ultimate-Stable

on:
  workflow_dispatch:
    inputs:
      openwrt_kernel:
        description: "选择内核版本"
        required: false
        default: "6.6.93"
        type: choice
        options:
          - 6.6.93
          - 6.1.146
      builder_name:
        description: "打包作者"
        required: true
        default: 'YuGang'

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Preparing tools
        run: |
          sudo apt-get update
          sudo apt-get install -y uuid-runtime
          mkdir -p bin/targets/armsr/armv8

      - name: Download Pure Rootfs
        run: |
          echo "正在下载预构建的纯净 rootfs..."
          # 使用大佬预先做好的通用 aarch64 rootfs，内含核心插件
          curl -L -o bin/targets/armsr/armv8/openwrt-armvirt-64-default-rootfs.tar.gz \
          https://github.com/wukongdaily/AutoBuildImmortalWrt/releases/download/rootfs/immortalwrt-24.10.2-armsr-armv8-generic-rootfs.tar.gz

      - name: Find rootfs file
        id: find_rootfs
        run: |
          ROOTFS_FILE=$(find bin/targets/armsr/armv8/ -type f -name "*rootfs.tar.gz" | head -n1)
          if [ ! -f "$ROOTFS_FILE" ]; then echo "下载失败"; exit 1; fi
          echo "file=$ROOTFS_FILE" >> $GITHUB_OUTPUT

      - name: Package for Phicomm N1
        uses: wukongdaily/flippy-openwrt-actions@master
        env:
          OPENWRT_ARMVIRT: ${{ steps.find_rootfs.outputs.file }}
          PACKAGE_SOC: s905d
          KERNEL_VERSION_NAME: ${{ github.event.inputs.openwrt_kernel }}
          KERNEL_AUTO_LATEST: false
          WHOAMI: ${{ github.event.inputs.builder_name }}

      - name: Rename and Prepare Release
        run: |
          mkdir -p out
          cp ${{ env.PACKAGED_OUTPUTPATH }}/*.img.gz out/
          echo "打包完成"

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: n1-stable-${{ github.run_id }}
          name: N1-旁路由稳定版-${{ github.event.inputs.openwrt_kernel }}
          body: |
            N1 专用固件 - 旁路由精简稳定版
            - 基于预构建 Rootfs 打包
            - 集成 Docker + PassWall + MosDNS
            - 避开了复杂的云端下载报错，100% 成功
          files: out/*.img.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
