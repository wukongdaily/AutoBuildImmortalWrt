name: Compile Single Package

on:
  workflow_dispatch:
    inputs:
      repo_url:
        description: "æ’ä»¶æºç çš„ GitHub åœ°å€"
        required: true
        default: "https://github.com/aige168/luci-app-accesscontrol"
      branch:
        description: "åˆ†æ”¯ (é€šå¸¸æ˜¯ main æˆ– master)"
        required: true
        default: "main"

jobs:
  build_package:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup OpenWrt SDK
        run: |
          # 1. å®‰è£…å¿…è¦çš„ç¼–è¯‘ä¾èµ– (ä¿®å¤ python3-pyelftools æŠ¥é”™)
          sudo apt-get update
          sudo apt-get install -y zstd python3-pyelftools
          
          # 2. è®¾ç½® SDK ä¸‹è½½åœ°å€ (ImmortalWrt 24.10.4 Rockchip/ARMv8)
          SDK_URL="https://downloads.immortalwrt.org/releases/24.10.4/targets/rockchip/armv8/immortalwrt-sdk-24.10.4-rockchip-armv8_gcc-13.3.0_musl.Linux-x86_64.tar.zst"
          
          echo "â¬‡ï¸ æ­£åœ¨ä¸‹è½½ SDK..."
          wget -q "$SDK_URL" -O sdk.tar.zst
          
          echo "ğŸ“¦ æ­£åœ¨è§£å‹ SDK..."
          # ä½¿ç”¨ zstd è§£å‹
          tar -I zstd -xvf sdk.tar.zst
          
          # 3. è‡ªåŠ¨å¯»æ‰¾è§£å‹å‡ºæ¥çš„ç›®å½•åå¹¶é‡å‘½åä¸º sdk
          SDK_DIR=$(find . -maxdepth 1 -type d -name "immortalwrt-sdk-*" | head -n 1)
          echo "Found SDK dir: $SDK_DIR"
          mv "$SDK_DIR" sdk
          
          # 4. è¿›å…¥ç›®å½•
          cd sdk
          
          echo "ğŸ”„ æ›´æ–° Feeds (ä¾èµ–æº)..."
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Clone Source Code
        run: |
          cd sdk/package
          echo "â¬‡ï¸ å…‹éš†æ’ä»¶æºç ..."
          git clone ${{ inputs.repo_url }} my-package
          
          cd my-package
          echo "ğŸ”€ åˆ‡æ¢åˆ†æ”¯åˆ° ${{ inputs.branch }}..."
          git checkout ${{ inputs.branch }} || echo "åˆ†æ”¯ä¸å­˜åœ¨ï¼Œå°è¯•é»˜è®¤åˆ†æ”¯"

      - name: Compile Package
        run: |
          cd sdk
          
          # ç”Ÿæˆé…ç½®æ–‡ä»¶
          make defconfig
          
          echo "ğŸ›  å¼€å§‹ç¼–è¯‘..."
          # V=s è¾“å‡ºè¯¦ç»†æ—¥å¿—
          # IGNORE_ERRORS=m å°è¯•å¿½ç•¥éå…³é”®ä¾èµ–é”™è¯¯
          make package/my-package/compile V=s

      - name: Find and Organize IPKs
        run: |
          mkdir -p output_ipks
          
          echo "ğŸ” æ­£åœ¨æœå¯»ç¼–è¯‘å¥½çš„ IPK æ–‡ä»¶..."
          # åœ¨ bin ç›®å½•ä¸‹æŸ¥æ‰¾æ‰€æœ‰ç”Ÿæˆçš„ ipk æ–‡ä»¶
          find sdk/bin/ -name "*.ipk" -exec cp {} output_ipks/ \;
          
          echo "âœ… æˆåŠŸæå–ä»¥ä¸‹æ–‡ä»¶ï¼š"
          ls -lh output_ipks/

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: compiled-ipk
          path: output_ipks/
