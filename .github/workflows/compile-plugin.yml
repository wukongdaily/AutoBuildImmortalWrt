name: Compile Single Package

on:
  workflow_dispatch:
    inputs:
      repo_url:
        description: "æ’ä»¶æºç çš„ GitHub åœ°å€"
        required: true
        default: "https://github.com/aige168/aige168" # è¿™é‡Œå¡«ä½ æƒ³ç¼–è¯‘çš„ä»“åº“åœ°å€
      branch:
        description: "åˆ†æ”¯ (é€šå¸¸æ˜¯ main æˆ– master)"
        required: true
        default: "main"

jobs:
  build_package:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup OpenWrt SDK
        run: |
          # 1. è®¾ç½® SDK ä¸‹è½½åœ°å€ (ä½¿ç”¨ ImmortalWrt 24.10.4 Rockchip/ARMv8 ç‰ˆæœ¬)
          SDK_URL="https://downloads.immortalwrt.org/releases/24.10.4/targets/rockchip/armv8/immortalwrt-sdk-24.10.4-rockchip-armv8_gcc-13.3.0_musl.Linux-x86_64.tar.xz"
          
          echo "â¬‡ï¸ æ­£åœ¨ä¸‹è½½ SDK..."
          wget -q "$SDK_URL" -O sdk.tar.xz
          
          echo "ğŸ“¦ æ­£åœ¨è§£å‹ SDK..."
          tar -xvf sdk.tar.xz
          
          # 2. è‡ªåŠ¨å¯»æ‰¾è§£å‹å‡ºæ¥çš„ç›®å½•åå¹¶é‡å‘½åä¸º sdk
          # å› ä¸ºè§£å‹å‡ºæ¥çš„åå­—å¤ªé•¿ä¸”åŒ…å«ç¼–è¯‘å™¨ç‰ˆæœ¬ï¼Œç”¨ find æŸ¥æ‰¾æœ€ç¨³å¦¥
          SDK_DIR=$(find . -maxdepth 1 -type d -name "immortalwrt-sdk-*" | head -n 1)
          echo "Found SDK dir: $SDK_DIR"
          mv "$SDK_DIR" sdk
          
          # 3. è¿›å…¥ç›®å½•
          cd sdk
          
          echo "ğŸ”„ æ›´æ–° Feeds (ä¾èµ–æº)..."
          # æ›´æ–°å¹¶å®‰è£…æ‰€æœ‰ feedsï¼Œç¡®ä¿ç¼–è¯‘æ—¶èƒ½æ‰¾åˆ°ä¾èµ–ï¼ˆå¦‚ luci-base, json ç­‰ï¼‰
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Clone Source Code
        run: |
          cd sdk/package
          echo "â¬‡ï¸ å…‹éš†æ’ä»¶æºç ..."
          git clone ${{ inputs.repo_url }} my-package
          
          cd my-package
          echo "ğŸ”€ åˆ‡æ¢åˆ†æ”¯åˆ° ${{ inputs.branch }}..."
          git checkout ${{ inputs.branch }} || echo "åˆ†æ”¯ä¸å­˜åœ¨ï¼Œå°è¯•é»˜è®¤åˆ†æ”¯"

      - name: Compile Package
        run: |
          cd sdk
          
          # ç”Ÿæˆé…ç½®æ–‡ä»¶ (è®© SDK è¯†åˆ«æ–°åŠ å…¥çš„åŒ…)
          make defconfig
          
          echo "ğŸ›  å¼€å§‹ç¼–è¯‘..."
          # V=s è¾“å‡ºè¯¦ç»†æ—¥å¿—ï¼Œå¦‚æœå‡ºé”™æ–¹ä¾¿æ’æŸ¥
          # -j$(nproc) ä½¿ç”¨å¤šæ ¸ç¼–è¯‘åŠ å¿«é€Ÿåº¦
          make package/my-package/compile V=s

      - name: Find and Organize IPKs
        run: |
          mkdir -p output_ipks
          
          echo "ğŸ” æ­£åœ¨æœå¯»ç¼–è¯‘å¥½çš„ IPK æ–‡ä»¶..."
          # åœ¨ bin ç›®å½•ä¸‹æŸ¥æ‰¾æ‰€æœ‰ç”Ÿæˆçš„ ipk æ–‡ä»¶
          find sdk/bin/ -name "*.ipk" -exec cp {} output_ipks/ \;
          
          echo "âœ… æˆåŠŸæå–ä»¥ä¸‹æ–‡ä»¶ï¼š"
          ls -lh output_ipks/

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: compiled-ipk
          path: output_ipks/
